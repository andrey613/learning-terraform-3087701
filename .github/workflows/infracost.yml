name: "Infracost analysis"

on:
  # trigger only when PR is raised because infracost needs to compare two branches to get cost difference
  pull_request:
    branches: [ main ]
    paths: 'terraform/**'

permissions:  # added using https://github.com/step-security/secure-workflows
  contents: read

jobs:
  infracost:
    permissions:
      contents: write
      pull-requests: write
    uses: /terraform-infracost-pr.yml
    with:
      terraform-var-file: ./.env/${{ inputs.env || 'dev' }}/terraform.tfvars
      usage-file: ./.env/${{ inputs.env || 'dev' }}/infracost-usage.yml
    secrets: inherit
  
  send-email:
    needs: infracost
    uses: andrey613/reusable-workflows-modules/.github/workflows/send-email.yml@main
    with:
      to: andrey6131@gmail.com
      subject: ${{ github.repository }} Cloud Cost Report
      body: Attached please find the cloud cost report generated by Infracost from worflow ${{ github.workflow }} of ${{ github.repository }}.
      attachment-flag: true
      attachments: report.html
    secrets: inherit